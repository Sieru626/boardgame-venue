# CPU名「CPU1」「CPU2」化の実装ノート

## 目的
ババ抜き・ミックスジュース・神経衰弱など全ゲームで、CPUプレイヤーに「CPU1 (Lv.3)」「CPU2 (Lv.2)」のように番号付きでわかりやすい名前を付ける。

---

## 実施した変更

### 1. サーバー `add_bot` ハンドラ (`server/index.js`)
- **変更**: CPU追加時に `name = \`CPU${cpuNumber} (Lv.${levelLabel})\`` を設定
- **ロジック**: 既存Bot数から次の番号を算出（`existingBots.length + 1` または既存の最大番号+1）
- **対象**: 新規に「CPU追加」ボタンで追加されるBotのみ

### 2. マイグレーション関数 `migrateOldBotNamesToCpuNumbers()`
- **目的**: 既存ゲームの「CPU (Lv.3)」を「CPU1 (Lv.3)」などに変換
- **実行タイミング**: `join_room` 時、`broadcastState` 時
- **条件**: Bot名に `CPU\d+` が含まれていなければ変換対象

### 3. DB一括マイグレーションスクリプト `server/migrate-cpu-names.js`
- **目的**: 全ゲームのDBを直接更新
- **実行**: `cd server && node migrate-cpu-names.js`
- **結果**: 16件のゲームをマイグレーション済み（実行ログ上は成功）

### 4. クライアント
- チャットのCPU関連判定を `/CPU\d+/.test(msg)` に変更（`page.tsx`）
- バージョン表示を v8.0 に更新（`UnifiedTable.tsx`）

---

## 失敗の原因（推測）

### 1. **実行パスの不一致**
- 編集対象: `C:\Users\user\.gemini\antigravity\scratch\boardgame-venue-mvp`
- ユーザーが起動しているサーバーが別のコピー（例: デスクトップや別フォルダ）の可能性
- `.gemini\antigravity\scratch\` は非標準パスのため、通常使うプロジェクトが別場所にあると変更が反映されない

### 2. **クライアントのキャッシュ**
- Next.js のビルドキャッシュやブラウザキャッシュで古いコードが残っている
- サーバー再起動だけではクライアントの再ビルドが走らない場合がある

### 3. **Socket / state の取得元**
- クライアントが受け取る state が、別サーバーや古いセッション由来である可能性
- 同一ポートで別プロセスが動いていると、接続先が想定と異なる

### 4. **マイグレーションの実行タイミング**
- `join_room` や `broadcastState` は「このプロジェクトのサーバー」が動いている前提
- 別プロジェクトのサーバーが動いていると、マイグレーション自体が実行されない

---

## 動作確認のポイント

1. **サーバー起動元の確認**: `start-all.bat` を実行しているフォルダが `boardgame-venue-mvp` であること
2. **起動ログの確認**: コンソールに `BoardGame Venue v8.0 (CPU1/2/3 naming)` が出ていること
3. **新規ルームでの確認**: ゲームリセット → 新規でCPU追加 → 「CPU1」「CPU2」と表示されること
4. **DBの直接確認**: `server/prisma/dev.db` がこのプロジェクトのものであること（別プロジェクトとDBを共有していないか）

---

## まとめ
コード上の変更は実装済みだが、**実行環境（プロジェクトパス・サーバー起動元・DB）の不一致**により、ユーザー環境では変更が反映されていない可能性が高い。

---

## 解消手順
詳細は **`docs/ACTION_PLAN_CPU_NAMING.md`** を参照。  
主な対応: 本物のプロジェクトフォルダで修正を再適用し、正しいパスから起動する。
