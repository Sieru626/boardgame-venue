# BoardGame Venue MVP プロジェクト現状ノート

**最終更新**: 2025年2月頃

---

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| **名前** | BoardGame Venue MVP |
| **場所** | `scratch/boardgame-venue-mvp` (AntiGravity 環境) |
| **技術** | Next.js + Socket.io + SQLite (Prisma) |
| **起動** | `start-all.bat` → ポート 3010 |
| **URL** | http://localhost:3010 |

---

## 2. 対応ゲームモード

| ゲーム | 説明 | CPU Bot | 備考 |
|--------|------|---------|------|
| **ババ抜き** | ペアを捨て、最後にジョーカーを持った人が負け | ✅ 対応 | 左隣から引く→ペア捨て |
| **神経衰弱** | カードのペアを当てるメモリゲーム | ✅ 対応 | 強CPUは約35%で正解狙い |
| **ミックスジュース** | カード合計値を競うサバイバル | ✅ 対応 | Lv別思考ロジック |
| **フリートーク** | ディストピア家族会議など | - | AI連携可能 |
| **通常 (Tabletop)** | 汎用卓上ゲーム | - | - |

---

## 3. CPU プレイヤー仕様

### 3.1 名前表示
- **形式**: `CPU1 (Lv.3)`, `CPU2 (Lv.2)`, `CPU3 (Lv.1)` など
- **追加時**: `add_bot` で番号付き名前を自動付与
- **既存データ**: `migrateOldBotNamesToCpuNumbers` でマイグレーション
- **実行**: `node server/migrate-cpu-names.js` で一括変換可能

### 3.2 神経衰弱 CPU（強度）
- **Lv.1 (weak) / Lv.2 (normal)**: 未めくりカードからランダム選択
- **Lv.3 (strong)**: 約35%の確率で正解を狙う（サーバー正解データ使用）、残りはランダムで人間らしくミス

### 3.3 ババ抜き CPU
- 自分の番で 2 秒後に左隣からカードを引く
- ペアがあれば捨てる

---

## 4. 先攻・後攻のランダム化

**全ゲームモード**で先攻がホスト固定にならないよう、手番順をシャッフル：

- **ババ抜き**: `order` をシャッフル
- **神経衰弱**: `turnSeat` をシャッフル
- **ミックスジュース**: `turnSeat` をシャッフル

**実装**: `shuffleOrder()` をトップレベル関数として定義し、`initializeStateFromActiveTemplate` と各ゲーム開始処理から共通利用。

---

## 5. 主な修正履歴（本セッション）

1. **神経衰弱 CPU Bot 実装**: `runMemoryBot` + `performMemoryFlip` で自動めくり
2. **CPU 名 CPU1/2/3 化**: `add_bot` とマイグレーション
3. **performMemoryFlip で broadcastState 使用**: マイグレーション適用・状態一貫性を確保
4. **神経衰弱強 CPU の弱体化**: 正解確率 60% → 35%
5. **先攻後攻ランダム化**: 全ゲームで `shuffleOrder` 適用
6. **shuffleOrder のスコープ修正**: `initializeStateFromActiveTemplate` から参照できるようトップレベルに移動
7. **GameSetupOverlay モード表示**: 神経衰弱・ミックスジュースの表示名を追加

---

## 6. 起動・運用

```bat
# 起動
start-all.bat

# 停止
BoardGame Venue のコンソールウィンドウを閉じる
```

- 必ず **http://localhost:3010** を使用（3000 は別アプリ用）
- 修正後はサーバー再起動が必要

---

## 7. 関連ファイル

| ファイル | 役割 |
|----------|------|
| `server/index.js` | ゲームロジック、Socket ハンドラ、Bot 処理 |
| `server/migrate-cpu-names.js` | CPU 名一括マイグレーション |
| `client/app/components/UnifiedTable.tsx` | メインゲーム UI |
| `client/app/components/GameSetupOverlay.tsx` | ゲーム準備オーバーレイ |
| `client/.env.local` | `NEXT_PUBLIC_SOCKET_URL=http://localhost:3010` |

---

## 8. テスト済み・動作確認済み

- 神経衰弱: CPU が適切にミスしながらプレイ
- 先攻後攻: ホスト以外が先攻になる場合がある
- CPU 名: CPU1, CPU2, CPU3 と表示
- ゲーム選択・テンプレート適用: `shuffleOrder` エラー解消
